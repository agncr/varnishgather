version: 2.1

commands:
  install_dependencies:
    parameters:
      repo:
        type: string
      token:
        type: env_var_name
      install:
        type: string
    steps:
      # Docker based images by default do not have lsmod or modprobe.
      # We need to install kmod so that the varnishgather can run in a container.
      - run:
          name: "Install dependencies"
          command: |
            if command -v apt-get > /dev/null; then
              apt update -y
              apt install -y kmod curl
            else
              yum update -y
              yum install -y kmod curl
            fi
            curl https://docs.varnish-software.com/scripts/setup.sh | TOKEN=${<<parameters.token>>} REPO=<<parameters.repo>> INSTALL="<<parameters.install>>" bash
jobs:
  varnishgather:
    parameters:
      platform:
        type: string
    docker:
      - image: <<parameters.platform>>
    steps:
      - checkout
      # Why does the varnishgather exit with a non-zero status code, even if
      # it is successfull? For now, I'm ignoring the exit code to make progress
      # on the CircleCi configuration.
      - run: ./varnishgather || true
      - run:
          name: "Move gather"
          command: |
            mkdir -p gathers/<<parameters.platform>>
            mv *.tar.gz gathers/<<parameters.platform>>/
      - persist_to_workspace:
          root: ./
          paths:
            - gathers
  test:
    docker:
      - image: cimg/python:3.9.2
    steps:
      - checkout
      - attach_workspace:
          at: ./gathers
      - run: python tests.py "gathers"

workflows:
  test:
    jobs:
      - varnishgather:
          pre-steps:
            - install_dependencies:
                repo: "41"
                token: "PROJECT_PACKAGECLOUD_41_TOKEN"
                install: "varnish-plus varnish-plus-vmods-extra varnish-plus-addon-ssl varnish-agent varnish-plus-ha varnish-custom-statistics-probe varnish-discovery"
          matrix:
            parameters:
              platform: [
                "debian:stretch",
                "ubuntu:trusty", "ubuntu:xenial",
                "centos:7"
              ]
      # - gather:
      #     name: "gather_60"
      #     parameters:
      #       token: "PROJECT_PACKAGECLOUD_60_TOKEN"
      #       repo: "60"
      #     matrix:
      #       parameters:
      #         platform: [
      #           "debian:buster", "debian:stretch", "debian:bullseye",
      #           "ubuntu:bionic", "ubuntu:focal", "ubuntu:xenial",
      #           "centos:7", "centos:8",
      #           "rockylinux:8"
      #         ]
      - test:
          requires: ["varnishgather"]
